<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FutureFlow Finance Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .gradient-bg {
            background-color: #111827;
            background-image: radial-gradient(at 47% 33%, hsl(200.00, 0%, 100%, 0.03) 0, transparent 59%), radial-gradient(at 82% 65%, hsl(215.00, 19%, 24%, 0.03) 0, transparent 55%);
        }
        ::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        .loader {
            border: 4px solid #f3f3f330;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .file-input-label {
            cursor: pointer;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            background-color: rgba(75, 85, 99, 0.5);
            transition: background-color 0.2s;
        }
        .file-input-label:hover {
            background-color: rgba(107, 114, 128, 0.5);
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            background-color: #2dd4bf;
            color: #1a202c;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 1000;
        }
        .toast.show {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body class="gradient-bg text-gray-200 min-h-screen">
    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400">FutureFlow Finance</h1>
            <p class="text-gray-400 mt-2">Track your spending, forecast your future with AI.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-1 space-y-8">
                <div class="bg-gray-800/50 backdrop-blur-sm p-6 rounded-2xl shadow-lg border border-gray-700/50">
                    <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Add Transaction</h2>
                    
                    <div class="mb-4 border border-dashed border-gray-600 rounded-lg p-4 text-center space-y-3">
                         <h3 class="font-semibold text-lg">Scan Document</h3>
                         <input type="file" id="upi-screenshot" accept="image/*" class="hidden">
                         <label for="upi-screenshot" class="file-input-label block">Upload UPI Screenshot</label>
                         <p id="file-name" class="text-xs text-gray-400">No image selected.</p>
                         <div class="hidden" id="image-preview-container"><img id="image-preview" src="" alt="Preview" class="max-h-40 mx-auto rounded-md"></div>
                         
                         <input type="file" id="pdf-statement" accept=".pdf" class="hidden">
                         <label for="pdf-statement" class="file-input-label block">Upload Bank Statement (PDF)</label>
                         <p id="pdf-file-name" class="text-xs text-gray-400">No PDF selected.</p>

                         <button id="analyze-document-btn" class="w-full mt-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg transition disabled:opacity-50" disabled>
                            Analyze Document
                         </button>
                         <div id="document-loader" class="hidden flex justify-center items-center mt-2"><div class="loader !w-6 !h-6"></div></div>
                    </div>
                    
                    <p class="text-center text-gray-500 my-2">OR</p>

                    <form id="transaction-form" class="space-y-4">
                        <input type="text" id="description" placeholder="Description" class="w-full bg-gray-700/50 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <input type="number" id="amount" placeholder="Amount" class="w-full bg-gray-700/50 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required min="0.01" step="0.01">
                        <input type="date" id="date" class="w-full bg-gray-700/50 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <select id="type" class="w-full bg-gray-700/50 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="expense">Expense</option>
                            <option value="income">Income</option>
                        </select>
                        <select id="category" class="w-full bg-gray-700/50 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                             <option value="Other">Category: Other</option>
                             <option value="Food">Food</option>
                             <option value="Transport">Transport</option>
                             <option value="Shopping">Shopping</option>
                             <option value="Utilities">Utilities</option>
                             <option value="Entertainment">Entertainment</option>
                             <option value="Income">Income</option>
                        </select>
                        <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-emerald-500 hover:from-blue-600 hover:to-emerald-600 text-white font-bold py-3 rounded-lg transition transform hover:-translate-y-0.5">
                            Add Manually
                        </button>
                    </form>
                </div>
                
                 <div class="bg-gray-800/50 backdrop-blur-sm p-6 rounded-2xl shadow-lg border border-gray-700/50">
                    <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">Monthly Goal</h2>
                    <div id="goal-display" class="hidden"></div>
                    <form id="goal-form">
                        <div class="space-y-3">
                            <input type="text" id="goal-description" placeholder="Goal (e.g., Save for vacation)" class="w-full bg-gray-700/50 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <input type="number" id="goal-amount" placeholder="Target Amount" class="w-full bg-gray-700/50 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required min="1">
                             <input type="text" id="goal-reward" placeholder="Reward (e.g., Fancy Dinner)" class="w-full bg-gray-700/50 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <button type="submit" class="w-full mt-4 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg transition">Set Goal</button>
                    </form>
                </div>

                <div class="bg-gray-800/50 backdrop-blur-sm p-6 rounded-2xl shadow-lg border border-gray-700/50">
                    <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">History</h2>
                    <div id="transaction-list" class="space-y-3 max-h-80 overflow-y-auto pr-2"></div>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-8">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-gray-800/50 p-5 rounded-2xl shadow-lg border border-gray-700/50">
                        <h3 class="text-sm font-medium text-emerald-400">MONTHLY INCOME</h3>
                        <p id="total-income" class="text-2xl font-bold mt-1">$0.00</p>
                    </div>
                    <div class="bg-gray-800/50 p-5 rounded-2xl shadow-lg border border-gray-700/50">
                        <h3 class="text-sm font-medium text-red-400">MONTHLY EXPENSES</h3>
                        <p id="total-expenses" class="text-2xl font-bold mt-1">$0.00</p>
                    </div>
                    <div class="bg-gray-800/50 p-5 rounded-2xl shadow-lg border border-gray-700/50">
                        <h3 class="text-sm font-medium text-blue-400">NET BALANCE</h3>
                        <p id="net-balance" class="text-2xl font-bold mt-1">$0.00</p>
                    </div>
                </div>

                <div class="bg-gray-800/50 backdrop-blur-sm p-6 rounded-2xl shadow-lg border border-gray-700/50">
                    <div class="flex justify-between items-center mb-4">
                         <h2 class="text-2xl font-semibold">Spending Trend</h2>
                         <div class="text-right">
                            <h3 class="text-sm font-medium text-gray-400">PROJECTED MONTHLY SPEND</h3>
                            <p id="projected-spending" class="text-xl font-bold text-orange-400">$0.00</p>
                         </div>
                    </div>
                    <canvas id="trend-chart" height="150"></canvas>
                </div>
                 
                <div class="bg-gray-800/50 backdrop-blur-sm p-6 rounded-2xl shadow-lg border border-gray-700/50">
                    <h2 class="text-2xl font-semibold mb-4">Your AI Financial Assistant</h2>
                    <div id="insights-loader" class="hidden flex justify-center items-center mt-4"><div class="loader"></div></div>
                    <div id="insights-output" class="mt-4 space-y-4 prose prose-invert max-w-none prose-p:text-gray-300 prose-headings:text-gray-100">
                        <p class="text-gray-400">Add a transaction to get your first financial analysis.</p>
                    </div>
                </div>
            </div>
        </main>
        <div id="toast" class="toast"></div>
    </div>

    <script type="module">
        // --- IMPORTANT ---
        import {GEMINI_API_KEY} from "../api/keys.js"
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;


        // DOM Elements
        const transactionForm = document.getElementById('transaction-form');
        const descriptionInput = document.getElementById('description');
        const amountInput = document.getElementById('amount');
        const dateInput = document.getElementById('date');
        const typeInput = document.getElementById('type');
        const categoryInput = document.getElementById('category');
        const transactionList = document.getElementById('transaction-list');
        const totalIncomeEl = document.getElementById('total-income');
        const totalExpensesEl = document.getElementById('total-expenses');
        const netBalanceEl = document.getElementById('net-balance');
        const projectedSpendingEl = document.getElementById('projected-spending');
        const trendChartCanvas = document.getElementById('trend-chart');
        const insightsOutput = document.getElementById('insights-output');
        const insightsLoader = document.getElementById('insights-loader');
        const goalForm = document.getElementById('goal-form');
        const goalDescriptionInput = document.getElementById('goal-description');
        const goalAmountInput = document.getElementById('goal-amount');
        const goalRewardInput = document.getElementById('goal-reward');
        const goalDisplay = document.getElementById('goal-display');
        const upiScreenshotInput = document.getElementById('upi-screenshot');
        const analyzeDocumentBtn = document.getElementById('analyze-document-btn');
        const fileNameEl = document.getElementById('file-name');
        const documentLoader = document.getElementById('document-loader');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const pdfStatementInput = document.getElementById('pdf-statement');
        const pdfFileNameEl = document.getElementById('pdf-file-name');
        const toastEl = document.getElementById('toast');
        
        // App state
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let goal = JSON.parse(localStorage.getItem('goal')) || null;
        let chartInstance = null;
        let fileToAnalyze = { type: null, data: null };
        
        // --- CORE FUNCTIONS ---
        const formatCurrency = amount => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
        
        const renderTransaction = (tx) => {
            const isExpense = tx.type === 'expense';
            const sign = isExpense ? '-' : '+';
            const item = document.createElement('div');
            item.className = 'flex justify-between items-center p-3 bg-gray-700/50 rounded-lg';
            item.innerHTML = `
                <div>
                    <p class="font-semibold">${tx.description}</p>
                    <p class="text-xs text-gray-400">${new Date(tx.date).toLocaleDateString()} <span class="ml-2 px-2 py-0.5 bg-gray-600 rounded-full text-xs">${tx.category}</span></p>
                </div>
                <div class="text-right">
                     <p class="font-bold ${isExpense ? 'text-red-400' : 'text-emerald-400'}">${sign} ${formatCurrency(tx.amount)}</p>
                     <button onclick="removeTransaction(${tx.id})" class="text-gray-500 hover:text-white text-xs mt-1">Remove</button>
                </div>`;
            transactionList.appendChild(item);
        };
        
        const showToast = (message) => {
            toastEl.textContent = message;
            toastEl.classList.add('show');
            setTimeout(() => toastEl.classList.remove('show'), 3000);
        };

        const addNewTransactions = (newTxs) => {
             const txsWithIds = newTxs.map(tx => ({
                ...tx,
                id: Date.now() + Math.random(), // Ensure unique ID
                amount: parseFloat(tx.amount)
            }));
            transactions.push(...txsWithIds);
            saveAndRerender();
            showToast(`${txsWithIds.length} transaction(s) added successfully!`);
        };
        
        // --- GOAL FUNCTIONS ---
        const renderGoal = () => {
             if (goal) {
                goalForm.classList.add('hidden');
                goalDisplay.classList.remove('hidden');
                const { balance } = calculateCurrentBalance();
                const progress = balance > 0 ? Math.min((balance / goal.amount) * 100, 100) : 0;
                let goalMessage = progress >= 100
                    ? `<p class="text-lg text-green-400 font-bold">ðŸŽ‰ Goal Achieved! ðŸŽ‰</p><p>Your reward: ${goal.reward}</p>`
                    : `<p>You are ${progress.toFixed(1)}% towards your goal of a ${formatCurrency(goal.amount)} net balance.</p>`;

                goalDisplay.innerHTML = `
                    <p class="font-semibold text-lg">${goal.description}</p>
                    <p class="text-gray-400">Target: ${formatCurrency(goal.amount)}</p>
                    <div class="w-full bg-gray-700 rounded-full h-2.5 mt-2">
                      <div class="bg-purple-600 h-2.5 rounded-full" style="width: ${progress}%"></div>
                    </div>
                    <div class="mt-2">${goalMessage}</div>
                    <button onclick="removeGoal()" class="text-red-500 hover:text-red-400 text-xs mt-3">Remove Goal</button>`;
             } else {
                 goalForm.classList.remove('hidden');
                 goalDisplay.classList.add('hidden');
             }
        };

        const setGoal = (e) => {
            e.preventDefault();
            goal = { description: goalDescriptionInput.value, amount: parseFloat(goalAmountInput.value), reward: goalRewardInput.value };
            localStorage.setItem('goal', JSON.stringify(goal));
            renderGoal();
            goalForm.reset();
        };

        const removeGoal = () => {
            goal = null;
            localStorage.removeItem('goal');
            renderGoal();
        };

        // --- UI & CALCULATION ---
        const calculateCurrentBalance = () => {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            const monthlyTransactions = transactions.filter(t => {
                const tDate = new Date(t.date);
                return tDate.getMonth() === currentMonth && tDate.getFullYear() === currentYear;
            });
            const income = monthlyTransactions.filter(t => t.type === 'income').reduce((acc, t) => acc + t.amount, 0);
            const expenses = monthlyTransactions.filter(t => t.type === 'expense').reduce((acc, t) => acc + t.amount, 0);
            return { income, expenses, balance: income - expenses, monthlyTransactions };
        };
        
        const updateUI = () => {
            const { income, expenses, balance, monthlyTransactions } = calculateCurrentBalance();
            totalIncomeEl.textContent = formatCurrency(income);
            totalExpensesEl.textContent = formatCurrency(expenses);
            netBalanceEl.textContent = formatCurrency(balance);
            
            const today = new Date();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            const dayOfMonth = today.getDate();
            const averageDailySpending = (dayOfMonth > 0 && expenses > 0) ? expenses / dayOfMonth : 0;
            projectedSpendingEl.textContent = formatCurrency(averageDailySpending * daysInMonth);
            updateChart(monthlyTransactions, averageDailySpending);
            renderGoal();
        };

        const updateChart = (monthlyTransactions, avgDaily) => {
            const today = new Date();
            const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            const dayOfMonth = today.getDate();
            const labels = Array.from({ length: daysInMonth }, (_, i) => i + 1);
            let cumulativeSpending = 0;
            const actualData = Array(daysInMonth).fill(null);
            
            for (let day = 1; day <= dayOfMonth; day++) {
                cumulativeSpending += monthlyTransactions.filter(t => t.type === 'expense' && new Date(t.date).getDate() === day).reduce((acc, t) => acc + t.amount, 0);
                actualData[day - 1] = cumulativeSpending;
            }
            
            const projectionData = [...actualData];
            let lastKnownSpending = cumulativeSpending;
            for (let day = dayOfMonth + 1; day <= daysInMonth; day++) {
                projectionData[day - 1] = lastKnownSpending + avgDaily * (day - dayOfMonth);
            }
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(trendChartCanvas.getContext('2d'), {
                type: 'line',
                data: { labels, datasets: [
                    { label: 'Actual Spending', data: actualData, borderColor: 'rgb(52, 211, 153)', backgroundColor: 'rgba(52, 211, 153, 0.1)', fill: true, tension: 0.3, },
                    { label: 'Projected Trend', data: projectionData, borderColor: 'rgb(251, 146, 60)', borderDash: [5, 5], tension: 0.3, fill: false, }
                ]},
                options: { responsive: true, plugins: { legend: { labels: { color: '#d1d5db' } } }, scales: {
                    y: { beginAtZero: true, ticks: { color: '#9ca3af', callback: v => `$${v}` }, grid: { color: 'rgba(107, 114, 128, 0.2)' } },
                    x: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(107, 114, 128, 0.2)' } }
                }}
            });
        };
        
        // --- TRANSACTION MANAGEMENT ---
        const addManualTransaction = (e) => {
            e.preventDefault();
            const newTransaction = {
                id: Date.now(), description: descriptionInput.value,
                amount: parseFloat(amountInput.value), date: dateInput.value,
                type: typeInput.value, category: categoryInput.value
            };
            transactions.push(newTransaction);
            saveAndRerender();
            transactionForm.reset();
            dateInput.value = new Date().toISOString().slice(0, 10);
        };

        const removeTransaction = (id) => {
            transactions = transactions.filter(t => t.id !== id);
            saveAndRerender();
        };

        // --- GEMINI & DOCUMENT ANALYSIS ---
        const debounce = (func, delay) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; };

        const getGeminiInsights = async () => {
            if (GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY_HERE') {
                insightsOutput.innerHTML = `<p class="text-orange-400">Add your Gemini API key to enable AI insights.</p>`; return;
            }
            const { balance, monthlyTransactions } = calculateCurrentBalance();
            if (monthlyTransactions.length === 0) {
                 insightsOutput.innerHTML = `<p class="text-gray-400">Add a transaction for analysis.</p>`; return;
            }
            insightsLoader.classList.remove('hidden');
            insightsOutput.innerHTML = '';

            const prompt = `You are FutureFlow, a friendly financial assistant. Analyze these JSON transactions for the current month. Today's Date: ${new Date().toLocaleDateString()}. Current Net Balance: ${formatCurrency(balance)}. \n\n ${JSON.stringify(monthlyTransactions)} \n\n Provide analysis in Markdown: \n\n### Spending Weak Points\n- Analyze top 2-3 spending categories. \n\n### Savings Suggestions\n- Provide 2-3 actionable savings tips based on their spending. \n\n### Future Trend Forecast\n- Give a narrative forecast for end-of-month spending.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) { const err = await response.json(); throw new Error(err.error.message); }
                const result = await response.json();
                const text = result.candidates[0].content.parts[0].text;
                insightsOutput.innerHTML = text.replace(/### (.*)/g, '<h3 class="text-lg font-semibold">$1</h3>').replace(/[\*-] (.*)/g, '<li class="ml-4 list-disc">$1</li>').replace(/\n/g, '<br>');
            } catch (error) {
                insightsOutput.innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
            } finally {
                insightsLoader.classList.add('hidden');
            }
        };
        
        const handleFileSelect = (event, type) => {
            const file = event.target.files[0];
            const nameEl = type === 'image' ? fileNameEl : pdfFileNameEl;
            const previewContainer = imagePreviewContainer;
            if (!file) {
                nameEl.textContent = `No ${type} selected.`;
                fileToAnalyze = { type: null, data: null };
                if (type === 'image') previewContainer.classList.add('hidden');
                analyzeDocumentBtn.disabled = true;
                return;
            };
            
            nameEl.textContent = file.name;
            const reader = new FileReader();
            reader.onloadend = () => {
                if(type === 'image') {
                    fileToAnalyze = { type: 'image', data: reader.result.split(',')[1], mime: file.type };
                    imagePreview.src = reader.result;
                    previewContainer.classList.remove('hidden');
                    pdfStatementInput.value = ''; // Reset other input
                    pdfFileNameEl.textContent = 'No PDF selected.';
                } else { // pdf
                    fileToAnalyze = { type: 'pdf', data: new Uint8Array(reader.result) };
                    upiScreenshotInput.value = ''; // Reset other input
                    fileNameEl.textContent = 'No image selected.';
                    previewContainer.classList.add('hidden');
                }
                analyzeDocumentBtn.disabled = false;
            };
            
            if(type === 'pdf') reader.readAsArrayBuffer(file);
            else reader.readAsDataURL(file);
        };

        const analyzeDocument = async () => {
            if (!fileToAnalyze.data || GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY_HERE') {
                alert('Please select a file and ensure your API key is set.'); return;
            }
            documentLoader.classList.remove('hidden'); analyzeDocumentBtn.disabled = true;

            const categories = "'Food', 'Transport', 'Shopping', 'Utilities', 'Entertainment', 'Income', 'Other'";
            let parts = [];

            if (fileToAnalyze.type === 'image') {
                 parts = [
                    { text: `Analyze the UPI screenshot. Extract all transactions into a valid JSON array. Each object needs keys: "amount" (number), "description" (string), "date" (string, "YYYY-MM-DD"), "type" (string, "expense" or "income"), and "category" (infer from ${categories}). Today is ${new Date().toISOString().slice(0, 10)}. Example: [{"amount": 150.75, "description": "Zomato", "date": "2025-09-24", "type": "expense", "category": "Food"}]`},
                    { inlineData: { mimeType: fileToAnalyze.mime, data: fileToAnalyze.data } }
                ];
            } else { // PDF
                try {
                    const pdf = await pdfjsLib.getDocument(fileToAnalyze.data).promise;
                    let pdfText = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        pdfText += textContent.items.map(item => item.str).join(' ');
                    }
                     parts = [{ text: `Analyze this bank statement text. Extract all transactions into a valid JSON array. Each object needs keys: "amount" (number, always positive), "description" (string), "date" (string, "YYYY-MM-DD"), "type" (string, "income" for credits, "expense" for debits), and "category" (infer from ${categories}). Current year is ${new Date().getFullYear()}. Ignore summaries. Text: \n\n ${pdfText}` }];
                } catch (error) {
                     alert("Error reading PDF file.");
                     documentLoader.classList.add('hidden'); analyzeDocumentBtn.disabled = false;
                     return;
                }
            }

             try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts }] })
                });
                if (!response.ok) throw new Error('API request failed');
                const result = await response.json();
                const textResponse = result.candidates[0].content.parts[0].text;
                const jsonMatch = textResponse.match(/\[.*\]/s);
                if (!jsonMatch) throw new Error("Could not find JSON array in the AI's response.");
                const data = JSON.parse(jsonMatch[0]);
                addNewTransactions(data);
            } catch (error) {
                console.error("Error analyzing document:", error);
                alert("Could not extract details from the document. Please try another file or enter manually.");
            } finally {
                documentLoader.classList.add('hidden'); analyzeDocumentBtn.disabled = false;
            }
        };

        const debouncedGetInsights = debounce(getGeminiInsights, 2000);
        const saveAndRerender = () => { localStorage.setItem('transactions', JSON.stringify(transactions)); init(); debouncedGetInsights(); };
        const init = () => { transactionList.innerHTML = ''; transactions.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(renderTransaction); updateUI(); };

        // Event Listeners
        transactionForm.addEventListener('submit', addManualTransaction);
        goalForm.addEventListener('submit', setGoal);
        upiScreenshotInput.addEventListener('change', (e) => handleFileSelect(e, 'image'));
        pdfStatementInput.addEventListener('change', (e) => handleFileSelect(e, 'pdf'));
        analyzeDocumentBtn.addEventListener('click', analyzeDocument);
        
        // Initial setup
        dateInput.value = new Date().toISOString().slice(0, 10);
        init();
        if (transactions.length > 0) getGeminiInsights();
    </script>
</body>
</html>

